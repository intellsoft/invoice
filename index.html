
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتورساز آنلاین | طراحی و چاپ فاکتور حرفه‌ای در کمتر از 5 دقیقه</title>
    <meta name="description" content="فاکتورساز آنلاین فارسی - طراحی و چاپ فاکتورهای زیبا و حرفه‌ای با امکان ذخیره در مرورگر، خروجی PDF و عکس. کاملاً رایگان و بدون نیاز به نصب">
    <meta name="keywords" content="فاکتورساز, فاکتور آنلاین, چاپ فاکتور, طراحی فاکتور, فاکتور فارسی, فاکتور فروش, نرم افزار فاکتور">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --border: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tahoma', 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 0;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #invoice-preview, #invoice-preview * {
                visibility: visible;
            }
            #invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        header h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
        }
        
        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .form-section {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            color: var(--dark);
            grid-column: 1 / -1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .items-section {
            grid-column: 1 / -1;
            margin-top: 10px;
        }
        
        .items-table-container {
            overflow-x: auto;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .items-table th, .items-table td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }
        
        .items-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .items-table input {
            width: 100%;
            border: none;
            text-align: center;
            padding: 8px 5px;
            font-size: 0.85rem;
            background: transparent;
        }
        
        .items-table input:focus {
            background-color: #f9f9f9;
            border: 1px solid var(--secondary);
            border-radius: 3px;
        }
        
        .add-item-container {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 20px;
        }
        
        .notes-section {
            grid-column: 1 / -1;
            margin-top: 10px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 18px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
            justify-content: center;
        }
        
        .invoice-preview {
            background-color: white;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 5px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .seller-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .seller-logo {
            width: 80px;
            height: 80px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #777;
            background-color: #f9f9f9;
            overflow: hidden;
        }
        
        .seller-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .seller-details {
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .invoice-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
        }
        
        .invoice-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .buyer-info {
            margin-bottom: 20px;
        }
        
        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }
        
        .invoice-items th, .invoice-items td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }
        
        .invoice-items th {
            background-color: #f2f2f2;
        }
        
        .invoice-totals {
            width: 50%;
            margin-right: auto;
            margin-bottom: 20px;
        }
        
        .invoice-totals table {
            width: 100%;
        }
        
        .invoice-totals td {
            padding: 8px;
        }
        
        .invoice-totals .total-row {
            font-weight: bold;
            border-top: 1px solid var(--border);
        }
        
        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .signature-box {
            width: 45%;
            text-align: center;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: var(--shadow);
        }
        
        .notification.show {
            opacity: 1;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #777;
            font-size: 0.8rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        footer a {
            color: var(--secondary);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
        }
        
        .export-options label {
            margin-bottom: 0;
            margin-left: 10px;
        }
        
        .export-options select {
            width: auto;
            min-width: 100px;
        }
        
        .logo-upload {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo-preview {
            width: 80px;
            height: 80px;
            border: 1px solid var(--border);
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 4px;
        }
        
        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .vat-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .vat-settings input[type="number"] {
            width: 80px;
        }
        
        .currency-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            margin: 0 auto;
            border-radius: 5px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Saved Invoices */
        .saved-invoices {
            margin-top: 30px;
        }
        
        .saved-invoices-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .saved-invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .saved-invoice-item:last-child {
            border-bottom: none;
        }
        
        .saved-invoice-actions {
            display: flex;
            gap: 5px;
        }
        
        /* WooCommerce Settings */
        .woocommerce-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .woocommerce-status.connected {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .woocommerce-status.disconnected {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .product-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .product-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .product-suggestion:hover {
            background-color: #f5f5f5;
        }
        
        .product-suggestion:last-child {
            border-bottom: none;
        }
        
        .stock-warning {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .seller-info {
                flex-direction: column;
            }
            
            .seller-logo {
                margin-top: 10px;
                align-self: center;
            }
            
            .invoice-totals {
                width: 100%;
            }
            
            .invoice-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content {
                margin: 10px auto;
            }
            
            .items-table {
                font-size: 0.75rem;
            }
            
            .items-table th, .items-table td {
                padding: 8px 5px;
            }
            
            .saved-invoice-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .saved-invoice-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .btn-group {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .export-options {
                flex-direction: column;
                gap: 5px;
            }
            
            .invoice-preview {
                padding: 15px;
            }
            
            .items-table th, .items-table td {
                padding: 6px 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="no-print">
            <h1>فاکتورساز آنلاین حرفه‌ای</h1>
            <p>طراحی و چاپ فاکتورهای زیبا در کمتر از 5 دقیقه - کاملاً رایگان و بدون نیاز به نصب</p>
            <button id="settings-btn" class="btn" style="margin-top: 10px;">تنظیمات ووکامرس</button>
        </header>
        
        <div class="form-section no-print">
            <div class="form-row">
                <h2 class="section-title">اطلاعات فاکتور</h2>
                
                <div class="form-group">
                    <label for="invoice-number">شماره فاکتور</label>
                    <input type="text" id="invoice-number" placeholder="مثال: INV-001">
                </div>
                
                <div class="form-group">
                    <label for="invoice-date">تاریخ فاکتور</label>
                    <input type="date" id="invoice-date">
                </div>
                
                <div class="form-group">
                    <div class="vat-settings">
                        <label for="vat-enabled">
                            <input type="checkbox" id="vat-enabled" checked>
                            اعمال مالیات ارزش افزوده
                        </label>
                        <input type="number" id="vat-percentage" min="0" max="100" value="9" style="width: 70px;">
                        <span>%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="currency-settings">
                        <label for="currency">واحد پول:</label>
                        <select id="currency">
                            <option value="toman">تومان</option>
                            <option value="rial">ریال</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <h3 class="section-title">اطلاعات فروشنده</h3>
                
                <div class="logo-upload">
                    <div class="logo-preview" id="logo-preview">
                        <span>لوگو</span>
                    </div>
                    <div>
                        <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                        <button id="upload-logo-btn" class="btn">آپلود لوگو</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="seller-name">نام فروشنده</label>
                    <input type="text" id="seller-name" placeholder="نام شرکت یا شخص">
                </div>
                
                <div class="form-group">
                    <label for="seller-address">آدرس فروشنده</label>
                    <textarea id="seller-address" rows="2" placeholder="آدرس کامل"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="seller-phone">تلفن فروشنده</label>
                    <input type="text" id="seller-phone" placeholder="شماره تلفن">
                </div>
            </div>
            
            <div class="form-row">
                <h3 class="section-title">اطلاعات مشتری</h3>
                
                <div class="form-group">
                    <label for="customer-name">نام مشتری</label>
                    <input type="text" id="customer-name" placeholder="نام شرکت یا شخص">
                </div>
                
                <div class="form-group">
                    <label for="customer-address">آدرس مشتری</label>
                    <textarea id="customer-address" rows="2" placeholder="آدرس کامل"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="customer-phone">تلفن مشتری</label>
                    <input type="text" id="customer-phone" placeholder="شماره تلفن">
                </div>
            </div>
            
            <div class="form-row">
                <h3 class="section-title">آیتم‌های فاکتور</h3>
                
                <div class="items-section">
                    <div class="items-table-container">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th width="5%">ردیف</th>
                                    <th width="30%">شرح کالا/خدمات</th>
                                    <th width="10%">تعداد</th>
                                    <th width="15%">قیمت واحد</th>
                                    <th width="15%">تخفیف</th>
                                    <th width="15%">جمع کل</th>
                                    <th width="10%">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="items-container">
                                <tr>
                                    <td>1</td>
                                    <td>
                                        <input type="text" class="item-description" placeholder="شرح آیتم">
                                        <div class="product-suggestions" style="display: none;"></div>
                                    </td>
                                    <td><input type="number" class="item-quantity" min="0" value="0"></td>
                                    <td><input type="number" class="item-price" min="0" value="0"></td>
                                    <td><input type="number" class="item-discount" min="0" value="0"></td>
                                    <td class="item-total">0</td>
                                    <td><button class="btn btn-danger remove-item">حذف</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="add-item-container">
                        <button id="add-item" class="btn">+ افزودن آیتم جدید</button>
                    </div>
                    
                    <div class="notes-section">
                        <div class="form-group">
                            <label for="notes">ملاحظات</label>
                            <textarea id="notes" rows="3" placeholder="توضیحات اضافی (اختیاری)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button id="preview-invoice" class="btn btn-success">پیش‌نمایش فاکتور</button>
                <button id="save-draft" class="btn">ذخیره پیش‌نویس</button>
                <button id="save-invoice" class="btn btn-success">ذخیره فاکتور</button>
                <button id="clear-all" class="btn btn-danger">پاک کردن همه (به جز اطلاعات فروشنده)</button>
            </div>
            
            <div class="saved-invoices no-print">
                <h3 class="section-title">فاکتورهای ذخیره شده</h3>
                <div class="saved-invoices-list" id="saved-invoices-list">
                    <!-- لیست فاکتورهای ذخیره شده -->
                </div>
            </div>
        </div>
        
        <footer class="no-print">
            <p>فاکتورساز آنلاین حرفه‌ای - طراحی و چاپ فاکتور در کمتر از 5 دقیقه | تمام حقوق محفوظ است © 2023</p>
            <p>طراحی شده توسط <a href="http://intellsoft.ir" target="_blank">اینتل سافت</a></p>
        </footer>
    </div>
    
    <!-- Modal for Invoice Preview -->
    <div id="preview-modal" class="modal no-print">
        <div class="modal-content">
            <div class="modal-header">
                <h2>پیش‌نمایش فاکتور</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <label for="paper-size">سایز کاغذ:</label>
                    <select id="paper-size">
                        <option value="a4">A4</option>
                        <option value="a5">A5</option>
                    </select>
                </div>
                
                <div class="invoice-preview" id="invoice-preview">
                    <div class="seller-info">
                        <div class="seller-details">
                            <div id="preview-seller-name" class="invoice-title">فروشنده</div>
                            <div id="preview-seller-address">آدرس فروشنده</div>
                            <div id="preview-seller-phone">تلفن فروشنده</div>
                        </div>
                        <div class="seller-logo" id="preview-logo">
                            لوگو
                        </div>
                    </div>
                    
                    <div class="invoice-header">
                        <h2>فاکتور فروش</h2>
                        <div class="invoice-meta">
                            <div>شماره: <span id="preview-invoice-number">-</span></div>
                            <div>تاریخ: <span id="preview-invoice-date">-</span></div>
                        </div>
                    </div>
                    
                    <div class="buyer-info">
                        <h3>خریدار: <span id="preview-customer-name">-</span></h3>
                        <div id="preview-customer-address">آدرس</div>
                        <div id="preview-customer-phone">تلفن</div>
                    </div>
                    
                    <table class="invoice-items">
                        <thead>
                            <tr>
                                <th>ردیف</th>
                                <th>شرح کالا/خدمات</th>
                                <th>تعداد</th>
                                <th>قیمت واحد</th>
                                <th>تخفیف</th>
                                <th>جمع کل</th>
                            </tr>
                        </thead>
                        <tbody id="preview-items">
                            <tr>
                                <td colspan="6">هیچ آیتمی اضافه نشده است</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="invoice-totals">
                        <table>
                            <tr>
                                <td>مجموع:</td>
                                <td id="preview-subtotal">0 <span class="currency-label">تومان</span></td>
                            </tr>
                            <tr id="vat-row">
                                <td>ارزش افزوده (<span id="vat-percentage-preview">9</span>%):</td>
                                <td id="preview-tax">0 <span class="currency-label">تومان</span></td>
                            </tr>
                            <tr id="discount-row" style="display: none;">
                                <td>تخفیف:</td>
                                <td id="preview-discount">0 <span class="currency-label">تومان</span></td>
                            </tr>
                            <tr class="total-row">
                                <td>مبلغ نهایی:</td>
                                <td id="preview-total">0 <span class="currency-label">تومان</span></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="signatures">
                        <div class="signature-box">
                            امضاء خریدار
                        </div>
                        <div class="signature-box">
                            امضاء فروشنده
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="print-invoice" class="btn">چاپ فاکتور</button>
                    <button id="export-pdf" class="btn">ذخیره PDF</button>
                    <button id="export-image" class="btn">ذخیره عکس</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for WooCommerce Settings -->
    <div id="settings-modal" class="modal no-print">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تنظیمات ووکامرس</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="wc-site-url">آدرس سایت ووکامرس</label>
                    <input type="url" id="wc-site-url" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label for="wc-consumer-key">کلید مصرف کننده (Consumer Key)</label>
                    <input type="password" id="wc-consumer-key" placeholder="ck_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                
                <div class="form-group">
                    <label for="wc-consumer-secret">کلید مخفی (Consumer Secret)</label>
                    <input type="password" id="wc-consumer-secret" placeholder="cs_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                
                <div class="woocommerce-status" id="wc-status">
                    وضعیت: غیرفعال
                </div>
                
                <div class="btn-group">
                    <button id="test-connection" class="btn">تست اتصال</button>
                    <button id="save-settings" class="btn btn-success">ذخیره تنظیمات</button>
                    <button id="fetch-products" class="btn">دریافت محصولات</button>
                </div>
                
                <div id="products-list" style="margin-top: 20px; max-height: 300px; overflow-y: auto; display: none;">
                    <h3>محصولات دریافت شده</h3>
                    <div id="products-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification no-print">تغییرات ذخیره شد</div>

    <script>
        // DOM Elements
        const invoiceNumber = document.getElementById('invoice-number');
        const invoiceDate = document.getElementById('invoice-date');
        const sellerName = document.getElementById('seller-name');
        const sellerAddress = document.getElementById('seller-address');
        const sellerPhone = document.getElementById('seller-phone');
        const customerName = document.getElementById('customer-name');
        const customerAddress = document.getElementById('customer-address');
        const customerPhone = document.getElementById('customer-phone');
        const itemsContainer = document.getElementById('items-container');
        const addItemBtn = document.getElementById('add-item');
        const notes = document.getElementById('notes');
        const saveDraftBtn = document.getElementById('save-draft');
        const clearAllBtn = document.getElementById('clear-all');
        const printInvoiceBtn = document.getElementById('print-invoice');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportImageBtn = document.getElementById('export-image');
        const previewInvoiceBtn = document.getElementById('preview-invoice');
        const saveInvoiceBtn = document.getElementById('save-invoice');
        const notification = document.getElementById('notification');
        const paperSizeSelect = document.getElementById('paper-size');
        const logoUpload = document.getElementById('logo-upload');
        const uploadLogoBtn = document.getElementById('upload-logo-btn');
        const logoPreview = document.getElementById('logo-preview');
        const previewLogo = document.getElementById('preview-logo');
        const previewModal = document.getElementById('preview-modal');
        const closeModal = document.querySelectorAll('.close-modal');
        const vatEnabled = document.getElementById('vat-enabled');
        const vatPercentage = document.getElementById('vat-percentage');
        const vatPercentagePreview = document.getElementById('vat-percentage-preview');
        const vatRow = document.getElementById('vat-row');
        const discountRow = document.getElementById('discount-row');
        const savedInvoicesList = document.getElementById('saved-invoices-list');
        const currencySelect = document.getElementById('currency');
        
        // WooCommerce Settings Elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const wcSiteUrl = document.getElementById('wc-site-url');
        const wcConsumerKey = document.getElementById('wc-consumer-key');
        const wcConsumerSecret = document.getElementById('wc-consumer-secret');
        const wcStatus = document.getElementById('wc-status');
        const testConnectionBtn = document.getElementById('test-connection');
        const saveSettingsBtn = document.getElementById('save-settings');
        const fetchProductsBtn = document.getElementById('fetch-products');
        const productsList = document.getElementById('products-list');
        const productsContainer = document.getElementById('products-container');
        
        // Paper sizes in mm
        const paperSizes = {
            a4: { width: 210, height: 297 },
            a5: { width: 148, height: 210 }
        };
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        invoiceDate.value = today;
        
        // Prevent recursive calls
        let isUpdatingPreview = false;
        
        // WooCommerce products cache
        let woocommerceProducts = [];
        
        // Initialize from localStorage
        loadFromStorage();
        loadSavedInvoices();
        loadWooCommerceSettings();
        
        // Event Listeners
        invoiceNumber.addEventListener('input', updatePreview);
        invoiceDate.addEventListener('input', updatePreview);
        sellerName.addEventListener('input', updatePreview);
        sellerAddress.addEventListener('input', updatePreview);
        sellerPhone.addEventListener('input', updatePreview);
        customerName.addEventListener('input', updatePreview);
        customerAddress.addEventListener('input', updatePreview);
        customerPhone.addEventListener('input', updatePreview);
        notes.addEventListener('input', updatePreview);
        vatEnabled.addEventListener('change', updatePreview);
        vatPercentage.addEventListener('input', updatePreview);
        currencySelect.addEventListener('change', updateCurrencyDisplay);
        
        addItemBtn.addEventListener('click', addNewItem);
        saveDraftBtn.addEventListener('click', saveToStorage);
        clearAllBtn.addEventListener('click', clearAll);
        printInvoiceBtn.addEventListener('click', printInvoice);
        exportPdfBtn.addEventListener('click', exportToPdf);
        exportImageBtn.addEventListener('click', exportToImage);
        previewInvoiceBtn.addEventListener('click', openPreviewModal);
        saveInvoiceBtn.addEventListener('click', saveInvoice);
        uploadLogoBtn.addEventListener('click', () => logoUpload.click());
        logoUpload.addEventListener('change', handleLogoUpload);
        
        // WooCommerce Settings Event Listeners
        settingsBtn.addEventListener('click', () => settingsModal.style.display = 'block');
        testConnectionBtn.addEventListener('click', testWooCommerceConnection);
        saveSettingsBtn.addEventListener('click', saveWooCommerceSettings);
        fetchProductsBtn.addEventListener('click', fetchWooCommerceProducts);
        
        // Close modals when clicking close button
        closeModal.forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                previewModal.style.display = 'none';
            }
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
        
        // Auto-save every 5 seconds without notification
        setInterval(() => {
            saveToStorage(true);
        }, 5000);
        
        // Functions
        function addNewItem() {
            const rowCount = itemsContainer.querySelectorAll('tr').length;
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${rowCount + 1}</td>
                <td>
                    <input type="text" class="item-description" placeholder="شرح آیتم">
                    <div class="product-suggestions" style="display: none;"></div>
                </td>
                <td><input type="number" class="item-quantity" min="0" value="0"></td>
                <td><input type="number" class="item-price" min="0" value="0"></td>
                <td><input type="number" class="item-discount" min="0" value="0"></td>
                <td class="item-total">0</td>
                <td><button class="btn btn-danger remove-item">حذف</button></td>
            `;
            
            itemsContainer.appendChild(newRow);
            
            // Add event listeners to new inputs
            const descriptionInput = newRow.querySelector('.item-description');
            const quantityInput = newRow.querySelector('.item-quantity');
            const discountInput = newRow.querySelector('.item-discount');
            const priceInput = newRow.querySelector('.item-price');
            const removeBtn = newRow.querySelector('.remove-item');
            const suggestionsContainer = newRow.querySelector('.product-suggestions');
            
            descriptionInput.addEventListener('input', function() {
                updatePreview();
                showProductSuggestions(this, suggestionsContainer);
            });
            
            descriptionInput.addEventListener('focus', function() {
                showProductSuggestions(this, suggestionsContainer);
            });
            
            quantityInput.addEventListener('input', updateItemTotal);
            discountInput.addEventListener('input', updateItemTotal);
            priceInput.addEventListener('input', updateItemTotal);
            removeBtn.addEventListener('click', function() {
                newRow.remove();
                updateRowNumbers();
                updatePreview();
                saveToStorage();
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!newRow.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            updateItemTotal.call(quantityInput);
            saveToStorage();
        }
        
        function showProductSuggestions(inputElement, suggestionsContainer) {
            const searchTerm = inputElement.value.toLowerCase();
            
            if (searchTerm.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const filteredProducts = woocommerceProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsContainer.innerHTML = '';
            filteredProducts.forEach(product => {
                const suggestion = document.createElement('div');
                suggestion.className = 'product-suggestion';
                suggestion.textContent = `${product.name} - ${formatCurrency(product.price)} - موجودی: ${product.stock_quantity || 0}`;
                suggestion.dataset.productId = product.id;
                suggestion.dataset.productName = product.name;
                suggestion.dataset.productPrice = product.price;
                suggestion.dataset.productStock = product.stock_quantity || 0;
                
                suggestion.addEventListener('click', function() {
                    inputElement.value = this.dataset.productName;
                    
                    const row = inputElement.closest('tr');
                    const priceInput = row.querySelector('.item-price');
                    priceInput.value = this.dataset.productPrice;
                    
                    // Check stock and show warning if needed
                    const quantityInput = row.querySelector('.item-quantity');
                    const stock = parseInt(this.dataset.productStock);
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    // Remove existing warnings
                    const existingWarning = row.querySelector('.stock-warning');
                    if (existingWarning) {
                        existingWarning.remove();
                    }
                    
                    if (quantity > stock) {
                        const warning = document.createElement('div');
                        warning.className = 'stock-warning';
                        warning.textContent = `توجه: موجودی این کالا ${stock} عدد است`;
                        row.querySelector('td:nth-child(3)').appendChild(warning);
                    }
                    
                    suggestionsContainer.style.display = 'none';
                    updateItemTotal.call(quantityInput);
                });
                
                suggestionsContainer.appendChild(suggestion);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        function updateRowNumbers() {
            const rows = itemsContainer.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }
        
        function updateItemTotal() {
            const row = this.closest('tr');
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const totalCell = row.querySelector('.item-total');
            
            const total = (quantity * price) - discount;
            
            totalCell.textContent = formatCurrency(total);
            
            updatePreview();
            saveToStorage();
        }
        
        function updatePreview() {
            if (isUpdatingPreview) return;
            isUpdatingPreview = true;
            
            // Update header
            document.getElementById('preview-invoice-number').textContent = invoiceNumber.value || '-';
            document.getElementById('preview-invoice-date').textContent = formatDate(invoiceDate.value) || '-';
            
            // Update seller info
            document.getElementById('preview-seller-name').textContent = sellerName.value || 'فروشنده';
            document.getElementById('preview-seller-address').textContent = sellerAddress.value || 'آدرس فروشنده';
            document.getElementById('preview-seller-phone').textContent = sellerPhone.value || 'تلفن فروشنده';
            
            // Update customer info
            document.getElementById('preview-customer-name').textContent = customerName.value || '-';
            document.getElementById('preview-customer-address').textContent = customerAddress.value || '';
            document.getElementById('preview-customer-phone').textContent = customerPhone.value || '';
            
            // Update items
            const previewItems = document.getElementById('preview-items');
            previewItems.innerHTML = '';
            let subtotal = 0;
            let totalDiscount = 0;
            
            const itemRows = itemsContainer.querySelectorAll('tr');
            if (itemRows.length === 0) {
                previewItems.innerHTML = '<tr><td colspan="6">هیچ آیتمی اضافه نشده است</td></tr>';
            } else {
                itemRows.forEach((row, index) => {
                    const description = row.querySelector('.item-description').value;
                    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                    const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const rowSubtotal = quantity * price;
                    const rowTotal = rowSubtotal - discount;
                    
                    subtotal += rowSubtotal;
                    totalDiscount += discount;
                    
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${description || '-'}</td>
                        <td>${quantity}</td>
                        <td>${formatCurrency(price)}</td>
                        <td>${formatCurrency(discount)}</td>
                        <td>${formatCurrency(rowTotal)}</td>
                    `;
                    
                    previewItems.appendChild(newRow);
                });
            }
            
            // Update totals
            const vatPercent = parseFloat(vatPercentage.value) || 0;
            const tax = vatEnabled.checked ? subtotal * (vatPercent / 100) : 0;
            const total = subtotal + tax - totalDiscount;
            
            document.getElementById('preview-subtotal').innerHTML = `${formatNumber(subtotal)} <span class="currency-label">${getCurrencyLabel()}</span>`;
            document.getElementById('preview-tax').innerHTML = `${formatNumber(tax)} <span class="currency-label">${getCurrencyLabel()}</span>`;
            document.getElementById('preview-discount').innerHTML = `${formatNumber(totalDiscount)} <span class="currency-label">${getCurrencyLabel()}</span>`;
            document.getElementById('preview-total').innerHTML = `${formatNumber(total)} <span class="currency-label">${getCurrencyLabel()}</span>`;
            
            // Update VAT display
            vatPercentagePreview.textContent = vatPercent;
            vatRow.style.display = vatEnabled.checked ? 'table-row' : 'none';
            
            // Update discount row visibility
            discountRow.style.display = totalDiscount > 0 ? 'table-row' : 'none';
            
            // Update currency labels in headers and totals
            updateCurrencyDisplay();
            
            isUpdatingPreview = false;
        }
        
        function getCurrencyLabel() {
            const currency = currencySelect.value;
            return currency === 'rial' ? 'ریال' : 'تومان';
        }
        
        function updateCurrencyDisplay() {
            const currencyLabel = getCurrencyLabel();
            
            // Update table headers in preview
            const priceHeader = document.querySelector('.invoice-items th:nth-child(4)');
            const discountHeader = document.querySelector('.invoice-items th:nth-child(5)');
            const totalHeader = document.querySelector('.invoice-items th:nth-child(6)');
            
            if (priceHeader) priceHeader.textContent = `قیمت واحد (${currencyLabel})`;
            if (discountHeader) discountHeader.textContent = `تخفیف (${currencyLabel})`;
            if (totalHeader) totalHeader.textContent = `جمع کل (${currencyLabel})`;
            
            // Update the main form table headers
            const formPriceHeader = document.querySelector('.items-table th:nth-child(4)');
            const formDiscountHeader = document.querySelector('.items-table th:nth-child(5)');
            const formTotalHeader = document.querySelector('.items-table th:nth-child(6)');
            
            if (formPriceHeader) formPriceHeader.textContent = `قیمت واحد (${currencyLabel})`;
            if (formDiscountHeader) formDiscountHeader.textContent = `تخفیف (${currencyLabel})`;
            if (formTotalHeader) formTotalHeader.textContent = `جمع کل (${currencyLabel})`;
            
            // Update currency labels in totals section
            document.querySelectorAll('.currency-label').forEach(el => {
                el.textContent = currencyLabel;
            });
            
            // Update the preview without recursion
            if (!isUpdatingPreview) {
                updatePreview();
            }
        }
        
        function formatNumber(amount) {
            return new Intl.NumberFormat('fa-IR').format(amount);
        }
        
        function formatCurrency(amount) {
            const formatted = new Intl.NumberFormat('fa-IR').format(amount);
            const currencyLabel = getCurrencyLabel();
            
            return `${formatted} ${currencyLabel}`;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                // Check if date is valid
                if (isNaN(date.getTime())) return '';
                
                return new Intl.DateTimeFormat('fa-IR').format(date);
            } catch (e) {
                console.error('Error formatting date:', e);
                return '';
            }
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    // Clear previous content
                    logoPreview.innerHTML = '';
                    previewLogo.innerHTML = '';
                    
                    // Add image to previews with fixed size
                    const logoPreviewImg = img.cloneNode();
                    const previewLogoImg = img.cloneNode();
                    
                    logoPreview.appendChild(logoPreviewImg);
                    previewLogo.appendChild(previewLogoImg);
                    
                    // Save to localStorage
                    saveToStorage();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function openPreviewModal() {
            updatePreview();
            previewModal.style.display = 'block';
        }
        
        function closePreviewModal() {
            previewModal.style.display = 'none';
        }
        
        function saveToStorage(isAutoSave = false) {
            const invoiceData = {
                invoiceNumber: invoiceNumber.value,
                invoiceDate: invoiceDate.value,
                sellerName: sellerName.value,
                sellerAddress: sellerAddress.value,
                sellerPhone: sellerPhone.value,
                customerName: customerName.value,
                customerAddress: customerAddress.value,
                customerPhone: customerPhone.value,
                notes: notes.value,
                logo: previewLogo.querySelector('img') ? previewLogo.querySelector('img').src : null,
                vatEnabled: vatEnabled.checked,
                vatPercentage: vatPercentage.value,
                currency: currencySelect.value,
                items: []
            };
            
            const itemRows = itemsContainer.querySelectorAll('tr');
            itemRows.forEach(row => {
                invoiceData.items.push({
                    description: row.querySelector('.item-description').value,
                    quantity: row.querySelector('.item-quantity').value,
                    discount: row.querySelector('.item-discount').value,
                    price: row.querySelector('.item-price').value
                });
            });
            
            localStorage.setItem('invoiceDraft', JSON.stringify(invoiceData));
            
            // Only show notification for manual saves
            if (!isAutoSave) {
                notification.textContent = 'تغییرات ذخیره شد';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }
        }
        
        function loadFromStorage() {
            const savedData = localStorage.getItem('invoiceDraft');
            
            if (savedData) {
                const invoiceData = JSON.parse(savedData);
                
                invoiceNumber.value = invoiceData.invoiceNumber || '';
                invoiceDate.value = invoiceData.invoiceDate || today;
                sellerName.value = invoiceData.sellerName || '';
                sellerAddress.value = invoiceData.sellerAddress || '';
                sellerPhone.value = invoiceData.sellerPhone || '';
                customerName.value = invoiceData.customerName || '';
                customerAddress.value = invoiceData.customerAddress || '';
                customerPhone.value = invoiceData.customerPhone || '';
                notes.value = invoiceData.notes || '';
                vatEnabled.checked = invoiceData.vatEnabled !== undefined ? invoiceData.vatEnabled : true;
                vatPercentage.value = invoiceData.vatPercentage || '9';
                currencySelect.value = invoiceData.currency || 'toman';
                
                // Load logo if exists
                if (invoiceData.logo) {
                    const img = document.createElement('img');
                    img.src = invoiceData.logo;
                    
                    logoPreview.innerHTML = '';
                    previewLogo.innerHTML = '';
                    
                    logoPreview.appendChild(img.cloneNode());
                    previewLogo.appendChild(img.cloneNode());
                }
                
                // Clear existing items
                itemsContainer.innerHTML = '';
                
                // Add saved items
                if (invoiceData.items && invoiceData.items.length > 0) {
                    invoiceData.items.forEach(item => {
                        addNewItem();
                        
                        const lastRow = itemsContainer.lastElementChild;
                        lastRow.querySelector('.item-description').value = item.description || '';
                        lastRow.querySelector('.item-quantity').value = item.quantity || 0;
                        lastRow.querySelector('.item-discount').value = item.discount || 0;
                        lastRow.querySelector('.item-price').value = item.price || 0;
                        
                        // Update the total for this row
                        const quantityInput = lastRow.querySelector('.item-quantity');
                        updateItemTotal.call(quantityInput);
                    });
                } else {
                    // Add one empty row if no items saved
                    addNewItem();
                }
                
                updatePreview();
                updateCurrencyDisplay();
            } else {
                // Add one empty row by default
                addNewItem();
                updateCurrencyDisplay();
            }
        }
        
        function clearAll() {
            if (confirm('آیا از پاک کردن تمام اطلاعات (به جز اطلاعات فروشنده) اطمینان دارید؟')) {
                // Save seller info before clearing
                const savedSellerName = sellerName.value;
                const savedSellerAddress = sellerAddress.value;
                const savedSellerPhone = sellerPhone.value;
                const savedLogo = previewLogo.querySelector('img') ? previewLogo.querySelector('img').src : null;
                
                invoiceNumber.value = '';
                invoiceDate.value = today;
                customerName.value = '';
                customerAddress.value = '';
                customerPhone.value = '';
                notes.value = '';
                
                itemsContainer.innerHTML = '';
                addNewItem();
                
                // Restore seller info
                sellerName.value = savedSellerName;
                sellerAddress.value = savedSellerAddress;
                sellerPhone.value = savedSellerPhone;
                
                if (savedLogo) {
                    const img = document.createElement('img');
                    img.src = savedLogo;
                    
                    logoPreview.innerHTML = '';
                    previewLogo.innerHTML = '';
                    
                    logoPreview.appendChild(img.cloneNode());
                    previewLogo.appendChild(img.cloneNode());
                }
                
                updatePreview();
                
                // Show notification
                notification.textContent = 'اطلاعات پاک شد (به جز اطلاعات فروشنده)';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }
        }
        
        function printInvoice() {
            window.print();
        }
        
        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const selectedSize = paperSizeSelect.value;
            const paperSize = paperSizes[selectedSize];
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [paperSize.width, paperSize.height]
            });
            
            // Capture the invoice preview as an image
            html2canvas(document.getElementById('invoice-preview'), {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = paperSize.width;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                doc.save(`فاکتور-${invoiceNumber.value || 'بدون-شماره'}.pdf`);
            });
        }
        
        function exportToImage() {
            const selectedSize = paperSizeSelect.value;
            const paperSize = paperSizes[selectedSize];
            
            // Calculate scale based on paper size
            const scale = paperSize.width / 210 * 2; // Base scale for A4
            
            html2canvas(document.getElementById('invoice-preview'), {
                scale: scale,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `فاکتور-${invoiceNumber.value || 'بدون-شماره'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        function saveInvoice() {
            const invoiceData = {
                id: Date.now(),
                invoiceNumber: invoiceNumber.value,
                invoiceDate: invoiceDate.value,
                sellerName: sellerName.value,
                sellerAddress: sellerAddress.value,
                sellerPhone: sellerPhone.value,
                customerName: customerName.value,
                customerAddress: customerAddress.value,
                customerPhone: customerPhone.value,
                notes: notes.value,
                logo: previewLogo.querySelector('img') ? previewLogo.querySelector('img').src : null,
                vatEnabled: vatEnabled.checked,
                vatPercentage: vatPercentage.value,
                currency: currencySelect.value,
                items: [],
                createdAt: new Date().toISOString()
            };
            
            const itemRows = itemsContainer.querySelectorAll('tr');
            itemRows.forEach(row => {
                invoiceData.items.push({
                    description: row.querySelector('.item-description').value,
                    quantity: row.querySelector('.item-quantity').value,
                    discount: row.querySelector('.item-discount').value,
                    price: row.querySelector('.item-price').value
                });
            });
            
            // Get existing saved invoices
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            
            // Add new invoice
            savedInvoices.push(invoiceData);
            
            // Save to localStorage
            localStorage.setItem('savedInvoices', JSON.stringify(savedInvoices));
            
            // Update the list
            loadSavedInvoices();
            
            // Show notification
            notification.textContent = 'فاکتور با موفقیت ذخیره شد';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }
        
        function loadSavedInvoices() {
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            
            savedInvoicesList.innerHTML = '';
            
            if (savedInvoices.length === 0) {
                savedInvoicesList.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">هیچ فاکتوری ذخیره نشده است</p>';
                return;
            }
            
            // Sort by creation date (newest first)
            savedInvoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            savedInvoices.forEach(invoice => {
                const invoiceElement = document.createElement('div');
                invoiceElement.className = 'saved-invoice-item';
                
                const date = new Date(invoice.createdAt);
                const formattedDate = date.toLocaleDateString('fa-IR');
                
                invoiceElement.innerHTML = `
                    <div>
                        <strong>${invoice.invoiceNumber || 'بدون شماره'}</strong> - 
                        ${invoice.customerName || 'بدون نام'} - 
                        ${formattedDate}
                    </div>
                    <div class="saved-invoice-actions">
                        <button class="btn" onclick="loadSavedInvoice(${invoice.id})">مشاهده</button>
                        <button class="btn btn-danger" onclick="deleteSavedInvoice(${invoice.id})">حذف</button>
                    </div>
                `;
                
                savedInvoicesList.appendChild(invoiceElement);
            });
        }
        
        function loadSavedInvoice(id) {
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            const invoice = savedInvoices.find(inv => inv.id === id);
            
            if (invoice) {
                invoiceNumber.value = invoice.invoiceNumber || '';
                invoiceDate.value = invoice.invoiceDate || today;
                sellerName.value = invoice.sellerName || '';
                sellerAddress.value = invoice.sellerAddress || '';
                sellerPhone.value = invoice.sellerPhone || '';
                customerName.value = invoice.customerName || '';
                customerAddress.value = invoice.customerAddress || '';
                customerPhone.value = invoice.customerPhone || '';
                notes.value = invoice.notes || '';
                vatEnabled.checked = invoice.vatEnabled !== undefined ? invoice.vatEnabled : true;
                vatPercentage.value = invoice.vatPercentage || '9';
                currencySelect.value = invoice.currency || 'toman';
                
                // Load logo if exists
                if (invoice.logo) {
                    const img = document.createElement('img');
                    img.src = invoice.logo;
                    
                    logoPreview.innerHTML = '';
                    previewLogo.innerHTML = '';
                    
                    logoPreview.appendChild(img.cloneNode());
                    previewLogo.appendChild(img.cloneNode());
                }
                
                // Clear existing items
                itemsContainer.innerHTML = '';
                
                // Add saved items
                if (invoice.items && invoice.items.length > 0) {
                    invoice.items.forEach(item => {
                        addNewItem();
                        
                        const lastRow = itemsContainer.lastElementChild;
                        lastRow.querySelector('.item-description').value = item.description || '';
                        lastRow.querySelector('.item-quantity').value = item.quantity || 0;
                        lastRow.querySelector('.item-discount').value = item.discount || 0;
                        lastRow.querySelector('.item-price').value = item.price || 0;
                        
                        // Update the total for this row
                        const quantityInput = lastRow.querySelector('.item-quantity');
                        updateItemTotal.call(quantityInput);
                    });
                } else {
                    // Add one empty row if no items saved
                    addNewItem();
                }
                
                updatePreview();
                updateCurrencyDisplay();
                closePreviewModal();
                
                // Show notification
                notification.textContent = 'فاکتور بارگذاری شد';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }
        }
        
        function printSavedInvoice(id) {
            loadSavedInvoice(id);
            setTimeout(() => {
                window.print();
            }, 500);
        }
        
        function deleteSavedInvoice(id) {
            if (confirm('آیا از حذف این فاکتور اطمینان دارید؟')) {
                const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
                const updatedInvoices = savedInvoices.filter(invoice => invoice.id !== id);
                
                localStorage.setItem('savedInvoices', JSON.stringify(updatedInvoices));
                loadSavedInvoices();
                
                // Show notification
                notification.textContent = 'فاکتور حذف شد';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }
        }
        
        // WooCommerce Functions
        function loadWooCommerceSettings() {
            const encryptedSettings = localStorage.getItem('woocommerceSettings');
            if (encryptedSettings) {
                try {
                    // Simple base64 decoding (not secure, just for basic obfuscation)
                    const decoded = atob(encryptedSettings);
                    const settings = JSON.parse(decoded);
                    
                    wcSiteUrl.value = settings.siteUrl || '';
                    wcConsumerKey.value = settings.consumerKey || '';
                    wcConsumerSecret.value = settings.consumerSecret || '';
                    
                    // Load cached products
                    const cachedProducts = localStorage.getItem('woocommerceProducts');
                    if (cachedProducts) {
                        woocommerceProducts = JSON.parse(cachedProducts);
                        updateWooCommerceStatus(true);
                    } else {
                        updateWooCommerceStatus(false);
                    }
                } catch (e) {
                    console.error('Error loading WooCommerce settings:', e);
                    updateWooCommerceStatus(false);
                }
            } else {
                updateWooCommerceStatus(false);
            }
        }
        
        function saveWooCommerceSettings() {
            const settings = {
                siteUrl: wcSiteUrl.value,
                consumerKey: wcConsumerKey.value,
                consumerSecret: wcConsumerSecret.value
            };
            
            // Simple base64 encoding (not secure, just for basic obfuscation)
            const encoded = btoa(JSON.stringify(settings));
            localStorage.setItem('woocommerceSettings', encoded);
            
            notification.textContent = 'تنظیمات ووکامرس ذخیره شد';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }
        
        function testWooCommerceConnection() {
            const siteUrl = wcSiteUrl.value;
            const consumerKey = wcConsumerKey.value;
            const consumerSecret = wcConsumerSecret.value;
            
            if (!siteUrl || !consumerKey || !consumerSecret) {
                notification.textContent = 'لطفاً تمام فیلدهای تنظیمات را پر کنید';
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
                return;
            }
            
            // Show loading state
            testConnectionBtn.textContent = 'در حال تست اتصال...';
            testConnectionBtn.disabled = true;
            
            // Simple test by trying to fetch products
            fetchWooCommerceProducts(true);
        }
        
        function fetchWooCommerceProducts(isTest = false) {
            const siteUrl = wcSiteUrl.value;
            const consumerKey = wcConsumerKey.value;
            const consumerSecret = wcConsumerSecret.value;
            
            if (!siteUrl || !consumerKey || !consumerSecret) {
                if (!isTest) {
                    notification.textContent = 'لطفاً ابتدا تنظیمات ووکامرس را ذخیره کنید';
                    notification.classList.add('show');
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
                return;
            }
            
            // Show loading state
            if (!isTest) {
                fetchProductsBtn.textContent = 'در حال دریافت محصولات...';
                fetchProductsBtn.disabled = true;
            }
            
            // Construct API URL
            const apiUrl = `${siteUrl}/wp-json/wc/v3/products?per_page=100`;
            
            // Basic authentication for WooCommerce REST API
            const auth = btoa(`${consumerKey}:${consumerSecret}`);
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Basic ${auth}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`خطا در اتصال: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(products => {
                // Process products
                woocommerceProducts = products.map(product => ({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    stock_quantity: product.stock_quantity,
                    sku: product.sku
                }));
                
                // Cache products in localStorage
                localStorage.setItem('woocommerceProducts', JSON.stringify(woocommerceProducts));
                
                // Update UI
                updateWooCommerceStatus(true);
                
                if (!isTest) {
                    // Show products list
                    displayProducts(products);
                    productsList.style.display = 'block';
                    
                    notification.textContent = `${products.length} محصول دریافت شد`;
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                } else {
                    notification.textContent = 'اتصال موفقیت‌آمیز بود';
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error fetching WooCommerce products:', error);
                updateWooCommerceStatus(false);
                
                notification.textContent = `خطا: ${error.message}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            })
            .finally(() => {
                // Reset button states
                testConnectionBtn.textContent = 'تست اتصال';
                testConnectionBtn.disabled = false;
                fetchProductsBtn.textContent = 'دریافت محصولات';
                fetchProductsBtn.disabled = false;
            });
        }
        
        function displayProducts(products) {
            productsContainer.innerHTML = '';
            
            if (products.length === 0) {
                productsContainer.innerHTML = '<p>هیچ محصولی یافت نشد</p>';
                return;
            }
            
            products.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'saved-invoice-item';
                productElement.innerHTML = `
                    <div>
                        <strong>${product.name}</strong><br>
                        قیمت: ${formatCurrency(product.price)} | موجودی: ${product.stock_quantity || 0} | SKU: ${product.sku || 'ندارد'}
                    </div>
                `;
                productsContainer.appendChild(productElement);
            });
        }
        
        function updateWooCommerceStatus(connected) {
            if (connected) {
                wcStatus.textContent = `وضعیت: متصل (${woocommerceProducts.length} محصول)`;
                wcStatus.className = 'woocommerce-status connected';
            } else {
                wcStatus.textContent = 'وضعیت: غیرفعال';
                wcStatus.className = 'woocommerce-status disconnected';
            }
        }
        
        // Initialize item event listeners
        function initializeItemEvents() {
            const quantityInputs = document.querySelectorAll('.item-quantity');
            const discountInputs = document.querySelectorAll('.item-discount');
            const priceInputs = document.querySelectorAll('.item-price');
            const removeButtons = document.querySelectorAll('.remove-item');
            
            quantityInputs.forEach(input => {
                input.addEventListener('input', updateItemTotal);
            });
            
            discountInputs.forEach(input => {
                input.addEventListener('input', updateItemTotal);
            });
            
            priceInputs.forEach(input => {
                input.addEventListener('input', updateItemTotal);
            });
            
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('tr').remove();
                    updateRowNumbers();
                    updatePreview();
                    saveToStorage();
                });
            });
        }
        
        // Initialize on load
        initializeItemEvents();
        updatePreview();
        updateCurrencyDisplay();
        
        // Make functions available globally for onclick handlers
        window.loadSavedInvoice = loadSavedInvoice;
        window.printSavedInvoice = printSavedInvoice;
        window.deleteSavedInvoice = deleteSavedInvoice;
    </script>
</body>
</html>
